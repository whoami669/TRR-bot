import discord
import os
from discord.ext import commands, tasks
from discord.utils import get
from datetime import datetime
from dotenv import load_dotenv

load_dotenv()
TOKEN = os.getenv("DISCORD_TOKEN")
GUILD_ID = int(os.getenv("GUILD_ID"))

intents = discord.Intents.all()
bot = commands.Bot(command_prefix="!", intents=intents)

# Channels and categories to auto-create
CATEGORIES = {
    "Server Info": ["welcome", "rules", "announcements"],
    "Community": ["general-chat", "memes", "polls", "introductions"],
    "Gaming": ["gaming-lounge", "find-a-squad", "screenshots", "clips"],
    "Voice Channels": ["General VC", "Gaming VC 1", "Gaming VC 2"]
}

@bot.event
async def on_ready():
    print(f"{bot.user.name} is now running!")
    guild = bot.get_guild(GUILD_ID)
    await setup_server(guild)
    daily_posts.start()

async def setup_server(guild):
    existing_channels = [channel.name for channel in guild.channels]
    for category_name, channels in CATEGORIES.items():
        category = get(guild.categories, name=category_name)
        if not category:
            category = await guild.create_category(category_name)

        for channel_name in channels:
            if channel_name not in existing_channels:
                if "vc" in channel_name.lower():
                    await guild.create_voice_channel(channel_name, category=category)
                else:
                    await guild.create_text_channel(channel_name, category=category)

@bot.event
async def on_member_join(member):
    guild = member.guild
    welcome_channel = get(guild.text_channels, name="welcome")
    role = get(guild.roles, name="Member")
    if not role:
        role = await guild.create_role(name="Member")
    await member.add_roles(role)
    if welcome_channel:
        await welcome_channel.send(f"Welcome to the server, {member.mention}! ğŸ‰")

@bot.event
async def on_message(message):
    if message.author == bot.user:
        return
    if "hello" in message.content.lower():
        await message.channel.send(f"Hey {message.author.name}, welcome back!")
    await bot.process_commands(message)

@bot.command()
async def poll(ctx, *, question):
    message = await ctx.send(f"ğŸ“Š **{question}**\nğŸ‘ Yes \t\t ğŸ‘ No")
    await message.add_reaction("ğŸ‘")
    await message.add_reaction("ğŸ‘")

@tasks.loop(hours=24)
async def daily_posts():
    guild = bot.get_guild(GUILD_ID)
    channel = get(guild.text_channels, name="general-chat")
    if channel:
        prompts = [
            "What game are you playing today?",
            "Share your favorite gaming clip!",
            "What's your weekend gaming plan?",
            "Drop a meme that describes your day."
        ]
        await channel.send(f"ğŸ¯ {random.choice(prompts)}")

bot.run(TOKEN)